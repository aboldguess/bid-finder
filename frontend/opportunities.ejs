<!DOCTYPE html>
<html>
<head>
  <title>Tender Dashboard</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <h1>Opportunities</h1>
  <%- include('partials/nav', { page: 'opportunities', user: user }) %>
  <table>
    <tr>
      <th>Title</th>
      <th data-type="date">Date</th>
      <th>Description</th>
      <th data-type="source">Source</th>
      <!-- New column showing when the tender was scraped (date only) -->
      <th data-type="date">Date Scraped</th>
      <th data-type="date">Scraped At</th>
      <th>Tags</th>
      <th>Link</th>
    </tr>
    <% tenders.forEach(t => { %>
      <!-- Each result row can be clicked to reveal a hidden detail row -->
      <tr class="tenderRow toggle-row" data-id="<%= t.id %>">
        <td><%= t.title %></td>
        <td><%= t.date %></td>
        <td><%= t.description %></td>
        <td><%= t.source %></td>
        <!-- Strip time for concise display -->
        <td><%= t.scraped_at ? t.scraped_at.slice(0,10) : '' %></td>
        <!-- Full timestamp retained for precise auditing -->
        <td><%= t.scraped_at %></td>
        <td><%= t.tags %></td>
        <!-- Open tender links in a new tab so the dashboard stays visible -->
        <td><a href="<%= t.link %>" target="_blank">View</a></td>
      </tr>
      <tr class="detailRow" data-id="<%= t.id %>">
        <td colspan="8">
          <table>
            <tr><th>Title</th><td><%= t.title %></td></tr>
            <tr><th>Date</th><td><%= t.date %></td></tr>
            <tr><th>Description</th><td><%= t.description %></td></tr>
            <tr><th>Source</th><td><%= t.source %></td></tr>
            <!-- Date only field aids quick visual scanning -->
            <tr><th>Date Scraped</th><td><%= t.scraped_at ? t.scraped_at.slice(0,10) : '' %></td></tr>
            <!-- Raw timestamp preserved for debugging -->
            <tr><th>Scraped At</th><td><%= t.scraped_at %></td></tr>
            <tr><th>Tags</th><td><%= t.tags %></td></tr>
            <tr><th>Link</th><td><a href="<%= t.link %>" target="_blank"><%= t.link %></a></td></tr>
          </table>
        </td>
      </tr>
    <% }) %>
  <% if (tenders.length === 0) { %>
      <tr><td colspan="8">No opportunities found. Try running the scraper.</td></tr>
  <% } %>
  </table>
  <div class="server-pagination">
    <% const totalPages = Math.max(1, Math.ceil(total / 100)); %>
    <% if (currentPage > 0) { %>
      <a href="/opportunities?page=<%= currentPage - 1 %>">Prev</a>
    <% } %>
    Page <%= currentPage + 1 %> of <%= totalPages %>
    <% if (currentPage < totalPages - 1) { %>
      <a href="/opportunities?page=<%= currentPage + 1 %>">Next</a>
    <% } %>
  </div>
  <!-- Table behaviour such as search, sort and detail toggling is provided -->
  <!-- by table-tools.js so no inline handlers are needed here -->
  <script src="/table-tools.js"></script>
</body>
</html>
